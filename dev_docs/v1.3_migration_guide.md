# DashSpec v1.3.0 Migration Guide

## Overview

DashSpec v1.3.0 introduces **default formatting** to reduce repetition and simplify dashboard specifications. Instead of defining formatting rules for every field, you can now set defaults that apply to all numeric fields, with per-field overrides.

## What's New

### `default_formatting` Field

A new optional field at `data_source` level that applies formatting to all numeric columns:

```yaml
data_source:
  type: parquet
  path: data/processed/my_data.parquet
  default_formatting:
    type: number
    precision: 2
    use_thousands_separator: true
```

### Inheritance Hierarchy

Formatting resolution follows this priority:

1. **Field-specific formatting** (highest priority) - `data_source.formatting.{field_name}`
2. **Default formatting** (fallback) - `data_source.default_formatting`
3. **No formatting** (if neither specified)

Field-specific formatting **overrides** default formatting properties.

## Migration Steps

### Step 1: Update Version

```yaml
# Old (v1.2)
dsl_version: 1.2.0

# New (v1.3)
dsl_version: 1.3.0
```

### Step 2: Extract Common Formatting

**Before (v1.2):**
```yaml
data_source:
  formatting:
    budget:
      type: integer
      use_thousands_separator: true
    revenue:
      type: integer
      use_thousands_separator: true
    popularity:
      type: number
      precision: 2
      use_thousands_separator: true
    vote_average:
      type: number
      precision: 2
      use_thousands_separator: true
    runtime:
      type: number
      precision: 2
      use_thousands_separator: true
```

**After (v1.3):**
```yaml
data_source:
  default_formatting:
    type: number
    precision: 2
    use_thousands_separator: true
  formatting:
    budget:
      type: integer  # Override: use integer instead of number
    revenue:
      type: integer  # Override: use integer instead of number
```

## Examples

### Example 1: Numeric Dashboard (Movies)

**v1.2 (repetitive):**
```yaml
dsl_version: 1.2.0
dashboard:
  data_source:
    formatting:
      budget:
        type: integer
        use_thousands_separator: true
      revenue:
        type: currency
        precision: 2
        use_thousands_separator: true
      popularity:
        type: number
        precision: 2
        use_thousands_separator: true
      vote_average:
        type: number
        precision: 2
        use_thousands_separator: true
      runtime:
        type: number
        precision: 2
        use_thousands_separator: true
```

**v1.3 (concise):**
```yaml
dsl_version: 1.3.0
dashboard:
  data_source:
    default_formatting:
      type: number
      precision: 2
      use_thousands_separator: true
    formatting:
      budget:
        type: integer
      revenue:
        type: currency
```

**Result:** Reduced from 24 lines to 11 lines (54% reduction)

### Example 2: Financial Dashboard

**v1.3 best practice:**
```yaml
data_source:
  default_formatting:
    type: currency
    precision: 2
    use_thousands_separator: true
  formatting:
    transaction_count:
      type: integer  # Override: counts aren't currency
    fraud_rate:
      type: percent  # Override: rates are percentages
      precision: 1
```

All monetary fields (revenue, amount, balance, etc.) automatically get currency formatting without explicit specification.

### Example 3: Scientific Data

**v1.3 with significant digits:**
```yaml
data_source:
  default_formatting:
    type: number
    significant_digits: 3
    use_thousands_separator: false
  formatting:
    sample_size:
      type: integer  # Override: counts need full precision
      use_thousands_separator: true
```

## Property Merging

Field-specific formatting **merges** with default formatting, allowing partial overrides:

```yaml
default_formatting:
  type: number
  precision: 2
  use_thousands_separator: true

formatting:
  temperature:
    precision: 1  # Only override precision
    # Inherits: type=number, use_thousands_separator=true
```

**Result:** `temperature` gets `{type: number, precision: 1, use_thousands_separator: true}`

## Backward Compatibility

### v1.2 Dashboards Still Work

- v1.3 supports all v1.2 dashboards
- If `default_formatting` is not specified, behavior is identical to v1.2
- `formatting` field works exactly as before
- No breaking changes

### Schema Versions Supported

The renderer supports: `["1.0", "1.1", "1.2", "1.3"]`

## Best Practices

### ✅ DO

1. **Use default_formatting for dashboards with many numeric fields**
   ```yaml
   default_formatting:
     type: number
     precision: 2
   formatting:
     id: { type: integer }  # Override specific fields
   ```

2. **Set domain-appropriate defaults**
   - Financial: `type: currency`
   - Scientific: `type: number, significant_digits: 3`
   - Counts/IDs: `type: integer`

3. **Override only what's different**
   ```yaml
   default_formatting: { type: number, precision: 2 }
   formatting:
     count: { type: integer }  # Just change type
   ```

### ⚠️ AVOID

1. **Don't use default_formatting with only 1-2 numeric fields**
   ```yaml
   # Bad: More verbose than direct formatting
   default_formatting: { type: number }
   formatting:
     revenue: { type: currency }
     count: { type: integer }
   ```

2. **Don't set defaults that most fields override**
   ```yaml
   # Bad: If most fields need overrides, just use formatting directly
   default_formatting: { type: currency }
   formatting:
     field1: { type: integer }  # Override
     field2: { type: number }   # Override
     field3: { type: percent }  # Override
   ```

## Implementation Details

### Formatting Resolution Function

```python
from dsl.core.formatting import resolve_field_formatting

# Returns merged formatting dict
format_spec = resolve_field_formatting(
    field_name="revenue",
    formatting={"revenue": {"type": "currency"}},
    default_formatting={"precision": 2, "use_thousands_separator": True}
)
# Result: {type: "currency", precision: 2, use_thousands_separator: True}
```

### Rendering Context

Renderers receive both `default_formatting` and `formatting`:

```python
rendering_context = {
    "default_formatting": {...},
    "formatting": {...},
    "column_labels": {...},
    # ... other metadata
}
```

## Migration Checklist

- [ ] Update `dsl_version` from `1.2.0` to `1.3.0`
- [ ] Identify common formatting patterns across fields
- [ ] Extract common properties to `default_formatting`
- [ ] Keep only field-specific overrides in `formatting`
- [ ] Test dashboard renders correctly
- [ ] Verify summary statistics show proper formatting
- [ ] Check that field-specific overrides work as expected

## Troubleshooting

### Issue: Fields not getting default formatting

**Cause:** `default_formatting` only applies if field has no explicit formatting

**Solution:** Remove field from `formatting` dict or merge properties

```yaml
# Wrong: Field explicitly set, default ignored
default_formatting: { precision: 2 }
formatting:
  revenue: { type: currency }  # Missing precision

# Right: Let default provide precision
default_formatting: { type: number, precision: 2 }
formatting:
  revenue: { type: currency }  # Inherits precision: 2
```

### Issue: Wrong format type applied

**Cause:** Field-specific `type` overrides default `type`

**Solution:** Ensure override has correct type

```yaml
default_formatting: { type: integer }
formatting:
  rate: { type: percent, precision: 1 }  # Correctly overrides to percent
```

## Version History

- **v1.3.0** (2025-01-10): Added `default_formatting` support
- **v1.2.0** (2025-01-09): Added field-specific formatting, currency, significant_digits
- **v1.1.0** (2024-12): Added data quality rules, metadata
- **v1.0.0** (2024-11): Initial release

## See Also

- [Schema v1.3 Specification](../dsl/schemas/schema.json)
- [Formatting Module](../dsl/core/formatting.py)
- [Example Dashboards](../dsl/examples/)
- [Error Handling Guide](./error_handling_guide.md)
